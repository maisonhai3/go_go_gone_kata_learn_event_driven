Tuy·ªát v·ªùi\! ƒê√¢y l√† m·ªôt b√†i th·ª±c h√†nh xu·∫•t s·∫Øc ƒë·ªÉ tr·∫£i nghi·ªám s·ª©c m·∫°nh v√† t∆∞ duy ƒë·∫±ng sau Ki·∫øn tr√∫c H∆∞·ªõng s·ª± ki·ªán (Event-Driven Architecture). Ch√∫ng ta s·∫Ω thi·∫øt k·∫ø v√† tri·ªÉn khai m·ªôt h·ªá th·ªëng nh·ªè b·∫±ng Python ƒë·ªÉ gi·∫£i quy·∫øt ch√≠nh x√°c y√™u c·∫ßu b·∫°n ƒë√£ n√™u.

Thay v√¨ g·ªçi c√°c h√†m tr·ª±c ti·∫øp, ch√∫ng ta s·∫Ω ƒë·ªÉ c√°c th√†nh ph·∫ßn giao ti·∫øp v·ªõi nhau b·∫±ng c√°ch "ph√°t" v√† "l·∫Øng nghe" c√°c s·ª± ki·ªán.

-----

### **Ph√¢n t√≠ch v√† Thi·∫øt k·∫ø**

Tr∆∞·ªõc khi vi·∫øt code, h√£y c√πng ph√¢n t√≠ch lu·ªìng s·ª± ki·ªán cho y√™u c·∫ßu: *"Ng∆∞·ªùi ƒë·∫•u gi√° ƒëƒÉng k√Ω b·∫±ng th·∫ª t√≠n d·ª•ng; h·ªá th·ªëng t·ª± ƒë·ªông tr·ª´ ti·ªÅn v√†o th·∫ª n·∫øu ng∆∞·ªùi ƒë√≥ th·∫Øng."*

1.  **S·ª± ki·ªán 1: `BidderRegistered` (Ng∆∞·ªùi ƒë·∫•u gi√° ƒë√£ ƒëƒÉng k√Ω)**

      * **Ai ph√°t:** `RegistrationService` (D·ªãch v·ª• ƒêƒÉng k√Ω)
      * **Khi n√†o:** Khi m·ªôt ng∆∞·ªùi d√πng ƒëƒÉng k√Ω th√†nh c√¥ng.
      * **Th√¥ng tin mang theo:** `bidder_id`, `name`, `credit_card_token` (ch√∫ng ta s·∫Ω kh√¥ng l∆∞u th√¥ng tin th·∫ª th·∫≠t, ch·ªâ m·ªôt m√£ ƒë·∫°i di·ªán an to√†n).

2.  **S·ª± ki·ªán 2: `AuctionEnded` (Phi√™n ƒë·∫•u gi√° ƒë√£ k·∫øt th√∫c)**

      * **Ai ph√°t:** `AuctionService` (D·ªãch v·ª• ƒê·∫•u gi√°)
      * **Khi n√†o:** Khi th·ªùi gian c·ªßa m·ªôt phi√™n ƒë·∫•u gi√° k·∫øt th√∫c.
      * **Th√¥ng tin mang theo:** `auction_id`, `winning_bidder_id`, `winning_price`.

3.  **S·ª± ki·ªán 3: `PaymentProcessed` (Thanh to√°n ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω)**

      * **Ai ph√°t:** `PaymentService` (D·ªãch v·ª• Thanh to√°n)
      * **Khi n√†o:** Sau khi c·ªë g·∫Øng tr·ª´ ti·ªÅn t·ª´ th·∫ª c·ªßa ng∆∞·ªùi th·∫Øng cu·ªôc.
      * **Th√¥ng tin mang theo:** `auction_id`, `bidder_id`, `amount`, `status` ('SUCCESS' ho·∫∑c 'FAILED').

**Lu·ªìng ho·∫°t ƒë·ªông s·∫Ω nh∆∞ sau:**
`AuctionService` ph√°t ra s·ª± ki·ªán `AuctionEnded`. `PaymentService` l·∫Øng nghe s·ª± ki·ªán n√†y. Khi nh·∫≠n ƒë∆∞·ª£c, n√≥ s·∫Ω x·ª≠ l√Ω thanh to√°n v√† sau ƒë√≥ ph√°t ra s·ª± ki·ªán `PaymentProcessed`. M·ªôt d·ªãch v·ª• kh√°c, v√≠ d·ª• nh∆∞ `NotificationService`, c√≥ th·ªÉ l·∫Øng nghe s·ª± ki·ªán `PaymentProcessed` ƒë·ªÉ g·ª≠i email cho ng∆∞·ªùi th·∫Øng cu·ªôc.

C√°c d·ªãch v·ª• n√†y ho√†n to√†n **kh√¥ng bi·∫øt** ƒë·∫øn s·ª± t·ªìn t·∫°i c·ªßa nhau. Ch√∫ng ch·ªâ bi·∫øt v·ªÅ "trung t√¢m tin t·ª©c" (Event Broker).

-----

### **Coding Example (Python)**

D∆∞·ªõi ƒë√¢y l√† m·ªôt v√≠ d·ª• ho√†n ch·ªânh, m√¥ ph·ªèng to√†n b·ªô lu·ªìng n√†y. Ch√∫ng ta s·∫Ω t·∫°o m·ªôt `EventBroker` ƒë∆°n gi·∫£n ƒë·ªÉ gi·ªØ cho v√≠ d·ª• d·ªÖ hi·ªÉu.

#### **1. `event_broker.py`: Trung t√¢m tin t·ª©c**

ƒê√¢y l√† tr√°i tim c·ªßa h·ªá th·ªëng. N√≥ qu·∫£n l√Ω vi·ªác ƒëƒÉng k√Ω l·∫Øng nghe v√† ph√°t c√°c s·ª± ki·ªán.

```python
# event_broker.py
from collections import defaultdict
from typing import Callable, Any

class EventBroker:
    def __init__(self):
        print("Event Broker initialized.")
        self._subscribers = defaultdict(list)

    def subscribe(self, event_type: str, callback: Callable):
        """ƒêƒÉng k√Ω m·ªôt h√†m callback ƒë·ªÉ l·∫Øng nghe m·ªôt lo·∫°i s·ª± ki·ªán."""
        print(f"New subscription: {callback.__qualname__} is listening for '{event_type}'")
        self._subscribers[event_type].append(callback)

    def publish(self, event_type: str, data: Any):
        """Ph√°t m·ªôt s·ª± ki·ªán ƒë·∫øn t·∫•t c·∫£ nh·ªØng ng∆∞·ªùi ƒë√£ ƒëƒÉng k√Ω."""
        print(f"\nüì¢ Publishing event '{event_type}' with data: {data}")
        if event_type in self._subscribers:
            for callback in self._subscribers[event_type]:
                try:
                    callback(data)
                except Exception as e:
                    print(f"Error calling callback {callback.__qualname__}: {e}")

# T·∫°o m·ªôt instance duy nh·∫•t ƒë·ªÉ to√†n b·ªô h·ªá th·ªëng s·ª≠ d·ª•ng
broker = EventBroker()
```

#### **2. `events.py`: ƒê·ªãnh nghƒ©a c√°c lo·∫°i tin t·ª©c**

Ch√∫ng ta d√πng `dataclasses` ƒë·ªÉ ƒë·ªãnh nghƒ©a c·∫•u tr√∫c c·ªßa c√°c s·ª± ki·ªán m·ªôt c√°ch r√µ r√†ng.

```python
# events.py
from dataclasses import dataclass
from uuid import UUID

@dataclass
class BidderRegistered:
    bidder_id: UUID
    name: str
    credit_card_token: str

@dataclass
class AuctionEnded:
    auction_id: UUID
    winning_bidder_id: UUID
    winning_price: float

@dataclass
class PaymentProcessed:
    auction_id: UUID
    bidder_id: UUID
    amount: float
    status: str
```

#### **3. `services.py`: C√°c b·ªô ph·∫≠n ch·ª©c nƒÉng**

ƒê√¢y l√† n∆°i ch·ª©a logic nghi·ªáp v·ª•. Ch√∫ √Ω c√°ch ch√∫ng ho√†n to√†n ƒë·ªôc l·∫≠p v·ªõi nhau.

```python
# services.py
import random
from uuid import UUID, uuid4
from event_broker import broker
from events import BidderRegistered, AuctionEnded, PaymentProcessed

class RegistrationService:
    def register_bidder(self, name: str, credit_card_number: str):
        print(f"[Registration Service] Registering bidder '{name}'...")
        # Gi·∫£ l·∫≠p vi·ªác g·ªçi c·ªïng thanh to√°n ƒë·ªÉ l·∫•y token an to√†n
        token = f"tok_{random.randint(1000, 9999)}"
        
        event = BidderRegistered(
            bidder_id=uuid4(),
            name=name,
            credit_card_token=token
        )
        broker.publish("BidderRegistered", event)
        return event.bidder_id

class AuctionService:
    def end_auction(self, auction_id: UUID, winner_id: UUID, price: float):
        print(f"[Auction Service] Auction '{auction_id}' has ended.")
        event = AuctionEnded(
            auction_id=auction_id,
            winning_bidder_id=winner_id,
            winning_price=price
        )
        broker.publish("AuctionEnded", event)

class PaymentService:
    def __init__(self):
        # Khi PaymentService kh·ªüi t·∫°o, n√≥ s·∫Ω t·ª± ƒë·ªông ƒëƒÉng k√Ω l·∫Øng nghe s·ª± ki·ªán
        broker.subscribe("AuctionEnded", self.handle_auction_ended)

    def handle_auction_ended(self, event: AuctionEnded):
        """ƒê√¢y l√† tr√°i tim c·ªßa y√™u c·∫ßu: l·∫Øng nghe v√† h√†nh ƒë·ªông."""
        print(f"[Payment Service] Received AuctionEnded event. Processing payment for winner '{event.winning_bidder_id}'.")
        
        # Gi·∫£ l·∫≠p vi·ªác g·ªçi c·ªïng thanh to√°n ƒë·ªÉ tr·ª´ ti·ªÅn
        # Logic th·ª±c t·∫ø s·∫Ω ph·ª©c t·∫°p h∆°n
        payment_successful = random.choice([True, False]) 
        status = "SUCCESS" if payment_successful else "FAILED"
        
        print(f"[Payment Service] Payment status: {status}")

        payment_event = PaymentProcessed(
            auction_id=event.auction_id,
            bidder_id=event.winning_bidder_id,
            amount=event.winning_price,
            status=status
        )
        broker.publish("PaymentProcessed", payment_event)

class NotificationService:
    def __init__(self):
        broker.subscribe("PaymentProcessed", self.handle_payment_processed)

    def handle_payment_processed(self, event: PaymentProcessed):
        print(f"[Notification Service] Received PaymentProcessed event.")
        if event.status == "SUCCESS":
            print(f"  -> Sending SUCCESS email to bidder '{event.bidder_id}' for winning auction '{event.auction_id}'.")
        else:
            print(f"  -> Sending FAILED email to bidder '{event.bidder_id}' for auction '{event.auction_id}'.")

```

#### **4. `main.py`: K·ªãch b·∫£n m√¥ ph·ªèng**

File n√†y s·∫Ω kh·ªüi t·∫°o c√°c d·ªãch v·ª• v√† m√¥ ph·ªèng m·ªôt lu·ªìng s·ª± ki·ªán ho√†n ch·ªânh.

```python
# main.py
from uuid import uuid4
from services import RegistrationService, AuctionService, PaymentService, NotificationService

if __name__ == "__main__":
    print("--- System Initialization ---")
    # Kh·ªüi t·∫°o c√°c d·ªãch v·ª•. Khi kh·ªüi t·∫°o, ch√∫ng s·∫Ω t·ª± ƒëƒÉng k√Ω v·ªõi broker.
    registration_service = RegistrationService()
    auction_service = AuctionService()
    payment_service = PaymentService()
    notification_service = NotificationService()
    print("--- System Ready ---\n")

    # --- K·ªãch b·∫£n m√¥ ph·ªèng ---
    print("--- Step 1: A new bidder registers ---")
    bidder_id = registration_service.register_bidder(
        name="Gia S∆∞ H·ªçc T·∫≠p", 
        credit_card_number="1234-5678-9012-3456"
    )

    print("\n--- Step 2: Some time passes, and an auction ends ---")
    auction_id = uuid4()
    
    # D·ªãch v·ª• ƒë·∫•u gi√° ph√°t s·ª± ki·ªán k·∫øt th√∫c.
    # N√≥ kh√¥ng c·∫ßn bi·∫øt ai s·∫Ω x·ª≠ l√Ω vi·ªác thanh to√°n.
    auction_service.end_auction(
        auction_id=auction_id,
        winner_id=bidder_id,
        price=99.99
    )

    print("\n--- Simulation Finished ---")
    print("Observe the chain of events triggered by 'AuctionEnded'.")
    print("PaymentService and NotificationService reacted without being called directly.")

```

### **C√°ch ch·∫°y v√† K·∫øt qu·∫£**

1.  L∆∞u 4 file tr√™n (`event_broker.py`, `events.py`, `services.py`, `main.py`) v√†o c√πng m·ªôt th∆∞ m·ª•c.
2.  M·ªü terminal trong th∆∞ m·ª•c ƒë√≥ v√† ch·∫°y: `python main.py`

**B·∫°n s·∫Ω th·∫•y m·ªôt output t∆∞∆°ng t·ª± nh∆∞ sau:**

```
--- System Initialization ---
Event Broker initialized.
New subscription: PaymentService.handle_auction_ended is listening for 'AuctionEnded'
New subscription: NotificationService.handle_payment_processed is listening for 'PaymentProcessed'
--- System Ready ---

--- Step 1: A new bidder registers ---
[Registration Service] Registering bidder 'Gia S∆∞ H·ªçc T·∫≠p'...

üì¢ Publishing event 'BidderRegistered' with data: BidderRegistered(bidder_id=..., name='Gia S∆∞ H·ªçc T·∫≠p', credit_card_token='tok_...')

--- Step 2: Some time passes, and an auction ends ---
[Auction Service] Auction '...' has ended.

üì¢ Publishing event 'AuctionEnded' with data: AuctionEnded(auction_id=..., winning_bidder_id=..., winning_price=99.99)
[Payment Service] Received AuctionEnded event. Processing payment for winner '...'.
[Payment Service] Payment status: SUCCESS

üì¢ Publishing event 'PaymentProcessed' with data: PaymentProcessed(auction_id=..., bidder_id=..., amount=99.99, status='SUCCESS')
[Notification Service] Received PaymentProcessed event.
  -> Sending SUCCESS email to bidder '...' for winning auction '...'.

--- Simulation Finished ---
Observe the chain of events triggered by 'AuctionEnded'.
PaymentService and NotificationService reacted without being called directly.
```

Nh∆∞ b·∫°n th·∫•y, h√†m `auction_service.end_auction()` ch·ªâ ph√°t ra m·ªôt s·ª± ki·ªán. H√†nh ƒë·ªông ƒë√≥ ƒë√£ k√≠ch ho·∫°t m·ªôt chu·ªói ph·∫£n ·ª©ng d√¢y chuy·ªÅn: `PaymentService` b·∫Øt ƒë∆∞·ª£c s·ª± ki·ªán v√† x·ª≠ l√Ω, sau ƒë√≥ l·∫°i ph√°t ra m·ªôt s·ª± ki·ªán m·ªõi, v√† `NotificationService` l·∫°i b·∫Øt ƒë∆∞·ª£c s·ª± ki·ªán ƒë√≥ ƒë·ªÉ h√†nh ƒë·ªông. ƒê√¢y ch√≠nh l√† b·∫£n ch·∫•t c·ªßa Ki·∫øn tr√∫c H∆∞·ªõng s·ª± ki·ªán: **h√†nh ƒë·ªông v√† ph·∫£n ·ª©ng m·ªôt c√°ch linh ho·∫°t v√† ƒë·ªôc l·∫≠p.**